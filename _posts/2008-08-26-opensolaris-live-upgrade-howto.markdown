---
layout: post
status: publish
published: true
title: OpenSolaris Live Upgrade HowTo
author:
  display_name: dynasty
  login: dynasty
  email: asanabria@linuxdynasty.org
  url: ''
author_login: dynasty
author_email: asanabria@linuxdynasty.org
excerpt: ! "<p>In this HowTo I will do my best to introduce you to the Solaris Live
  Upgrade process. Recently, I have had to do this quite a bit and I figured why not
  and just write up a quick HowTo on this subject. As a few of you already know I
  am not a fan of OpenSolaris, though as of recent I am starting to get drawn into
  it. </p>\r\n<p>One thing about the Live Upgrade process is that it allows you to
  have multiple BE's ( Bootable Environments ). This is so cool, since this allows
  you to have a CLEAN BE and the others to Test/Destroy/...Whatever. First things
  first you need to make sure that you have at least one available partition that
  is big enough to to transfer your current environment and enough space to do the
  Live Upgrade as well as have the OpenSolaris Express Image. OK, lets get into the
  Live Upgrade process....</p>\r\n<br />"
wordpress_id: 203
wordpress_url: http://linuxdynasty.org/?p=203
date: !binary |-
  MjAwOC0wOC0yNiAxNToxMzo1MSAtMDQwMA==
date_gmt: !binary |-
  MjAwOC0wOC0yNiAxNToxMzo1MSAtMDQwMA==
categories: []
tags:
- Advance OpenSolaris HowTo's
- OpenSolaris Live Upgrade HowTo LiveUpgrade
comments: []
---
<p>In this HowTo I will do my best to introduce you to the Solaris Live Upgrade process. Recently, I have had to do this quite a bit and I figured why not and just write up a quick HowTo on this subject. As a few of you already know I am not a fan of OpenSolaris, though as of recent I am starting to get drawn into it. </p>
<p>One thing about the Live Upgrade process is that it allows you to have multiple BE's ( Bootable Environments ). This is so cool, since this allows you to have a CLEAN BE and the others to Test/Destroy/...Whatever. First things first you need to make sure that you have at least one available partition that is big enough to to transfer your current environment and enough space to do the Live Upgrade as well as have the OpenSolaris Express Image. OK, lets get into the Live Upgrade process....</p>
<p><a id="more"></a><a id="more-203"></a></p>
<p>&nbsp;</p>
<ol>
<li>Verify that you have at least ONE partition aka slice available...You will need to use the <font color="#0000ff"><strong>format</strong></font> command.<br />
Here is the example output...</p>
<p></p>
<pre>bash-3.2# format<br /><br />Searching for disks...done<br />AVAILABLE DISK SELECTIONS:<br /><br />0. c0d0 &lt;DEFAULT cyl 9726 alt 2 hd 255 sec 63&gt;<br /><br />/pci@0,0/pci-ide@1f,1/ide@1/cmdk@0,0<br /><br />Specify disk (enter its number): 0<br /><br />selecting c0d0<br /><br />Controller working list found<br /><br />[disk formatted, defect list found]<br /><br />Warning: Current Disk has mounted partitions.<br /><br />/dev/dsk/c0d0s5 is in use for live upgrade /. Please see ludelete(1M).<br /><br />/dev/dsk/c0d0s1 is currently used by swap. Please see swap(1M).<br /><br />/dev/dsk/c0d0s6 is in use for live upgrade /var. Please see ludelete(1M).<br /><br />/dev/dsk/c0d0s4 is currently mounted on /backup. Please see umount(1M).<br /><br />/dev/dsk/c0d0s0 is currently mounted on /. Please see umount(1M).<br /><br />/dev/dsk/c0d0s3 is currently mounted on /var. Please see umount(1M).<br /><br />/dev/dsk/c0d0s7 is currently mounted on /export. Please see umount(1M).<br /></pre>
<p>
</li>
<li>Get the solexpress dvd iso image... I used solexpres95 &quot;<strong>sol-nv-b95-x86-dvd.iso</strong>&quot;</li>
<li>You now need to mount the OpenSolaris Image using lofiadm. The HowTo for that is here... <br />
<a href="http://www.linuxdynasty.org/how-to-mount-an-iso-image-under-solaris-or-opensolaris.html%20" title=""><br />
http://www.linuxdynasty.org/how-to-mount-an-iso-image-under-solaris-or-opensolaris.html </a></li>
<li>Run the <font color="#0000ff"><strong>lucreate</strong></font> command. This command will label the current BE ( Which is the default Environment you are logged into )using the <font color="#0000ff"><strong>-c</strong></font> option then you need to specify the mounts you want to use and on what partition you want them on using the <font color="#0000ff"><strong>-m</strong></font> option. Example below..
<p>
</li>
</ol>
<pre>bash-3.2# <strong><font color="#0000ff">lucreate -c</font> <font color="#ff0000">solexpr81</font> <font color="#0000ff">-m</font> <font color="#ff0000">/:/dev/dsk/c0d0s5:ufs</font> <font color="#0000ff">-m</font> <font color="#ff0000">/var:/dev/dsk/c0d0s6:ufs</font> <font color="#0000ff">-n</font> <font color="#ff0000">solexpr95</font></strong><br /><br />Discovering physical storage devices<br /><br />Discovering logical storage devices<br /><br />Cross referencing storage devices with boot environment configurations<br /><br />Determining types of file systems supported<br /><br />Validating file system requests<br /><br />Preparing logical storage devices<br /><br />Preparing physical storage devices<br /><br />Configuring physical storage devices<br /><br />Configuring logical storage devices<br /><br />Analyzing system configuration.<br /><br />Comparing source boot environment &lt;solexpr81&gt; file systems with the file<br /><br />system(s) you specified for the new boot environment. Determining which<br /><br />file systems should be in the new boot environment.<br /><br />Updating boot environment description database on all BEs.<br /><br />Searching /dev for possible boot environment filesystem devices<br /><p>Updating system configuration files.<br /><br />The device &lt;/dev/dsk/c0d0s5&gt; is not a root device for any boot environment; cannot get BE ID.<br /><br />Creating configuration for boot environment &lt;solexpr9&gt;.<br /><br />Source boot environment is &lt;solexpr81&gt;.<br /><br />Creating boot environment &lt;solexpr9&gt;.<br /><br />Checking for GRUB menu on boot environment &lt;solexpr9&gt;.<br /><br />The boot environment &lt;solexpr9&gt; does not contain the GRUB menu.<br /><br />Creating file systems on boot environment &lt;solexpr9&gt;.<br /><br />Creating &lt;ufs&gt; file system for &lt;/&gt; in zone &lt;global&gt; on &lt;/dev/dsk/c0d0s5&gt;.<br /><br />Creating &lt;ufs&gt; file system for &lt;/var&gt; in zone &lt;global&gt; on &lt;/dev/dsk/c0d0s6&gt;.<br /><br />Mounting file systems for boot environment &lt;solexpr9&gt;.<br /><br />Calculating required sizes of file systems for boot environment &lt;solexpr9&gt;.<br /><br />Populating file systems on boot environment &lt;solexpr9&gt;.<br /><br />Checking selection integrity.<br /><br />Integrity check OK.<br /><br />Populating contents of mount point &lt;/&gt;.<br /><br />Populating contents of mount point &lt;/var&gt;.<br /><br />Copying.<br /><br />WARNING: The file &lt;/tmp/lucopy.errors.6170&gt; contains a list of &lt;6&gt;<br /><br />potential problems (issues) that were encountered while populating boot<br /><br />environment &lt;solexpr9&gt;.<br /><br />INFORMATION: You must review the issues listed in<br /><br />&lt;/tmp/lucopy.errors.6170&gt; and determine if any must be resolved. In<br /><br />general, you can ignore warnings about files that were skipped because<br /><br />they did not exist or could not be opened. You cannot ignore errors such<br /><br />as directories or files that could not be created, or file systems running<br /><br />out of disk space. You must manually resolve any such problems before you<br /><br />activate boot environment &lt;solexpr95&gt;.</p><p>Creating shared file system mount points.<br /><br />Copying root of zone &lt;logger&gt;.<br /><br />Copying root of zone &lt;zenoss&gt;.<br /><br />Copying root of zone &lt;ipf&gt;.<br /><br />Creating compare databases for boot environment &lt;solexpr95&gt;.<br /><br />Creating compare database for file system &lt;/var&gt;.<br /><br />Creating compare database for file system &lt;/&gt;.<br /><br />Updating compare databases on boot environment &lt;solexpr95&gt;.<br /><br />Making boot environment &lt;solexpr95&gt; bootable.<br /><br />Updating bootenv.rc on ABE &lt;solexpr95&gt;.<br /><br />Population of boot environment &lt;solexpr95&gt; successful.<br /><br />Creation of boot environment &lt;solexpr95&gt; successful.</p><br /></pre>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;&nbsp; 6. Once the lucreate command finishes ( Takes about 15 to 30 minutes, at least for me it does), You now have to run the <font color="#0000ff"><strong>luupgrade</strong></font> command.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The <font color="#0000ff"><strong>-u</strong></font> option stands for upgrand and the <font color="#0000ff"><strong>-n</strong></font> option stands for the name of the BE that you are upgrading and the <font color="#0000ff"><strong>-s</strong></font> options stands for <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; the source image location that you are using.</p>
<p>&nbsp;</p>
<pre>bash-3.2# <font color="#0000ff"><strong>luupgrade</strong> </font><strong><font color="#0000ff">-u -n</font> <font color="#ff0000">solexpr95</font> <font color="#0000ff">-s</font> <font color="#ff0000">/mnt/</font></strong><br /><br />Copying failsafe kernel from media.<br /><br />Uncompressing miniroot<br /><br />Uncompressing miniroot archive (Part2)<br /><br />13364 blocks<br /><br />Creating miniroot device<br /><br />miniroot filesystem is &lt;ufs&gt;<br /><br />Mounting miniroot at &lt;/mnt//Solaris_11/Tools/Boot&gt;<br /><br />Mounting miniroot Part 2 at &lt;/mnt//Solaris_11/Tools/Boot&gt;<br /><br />Validating the contents of the media &lt;/mnt/&gt;.<br /><br />The media is a standard Solaris media.<br /><br />The media contains an operating system upgrade image.<br /><br />The media contains &lt;Solaris&gt; version &lt;11&gt;.<br /><br />Constructing upgrade profile to use.<br /><br />Locating the operating system upgrade program.<br /><br />Checking for existence of previously scheduled Live Upgrade requests.<br /><br />Creating upgrade profile for BE &lt;solexpr95&gt;.<br /><br />Checking for GRUB menu on ABE &lt;solexpr95&gt;.<br /><br />Checking for x86 boot partition on ABE.<br /><br />Determining packages to install or upgrade for BE &lt;solexpr95&gt;.<br /><br />Performing the operating system upgrade of the BE &lt;solexpr95&gt;.<br /><br />CAUTION: Interrupting this process may leave the boot environment unstable<br /><br />or unbootable.<br /><br /><br />Upgrading Solaris: 61% completed<br /><br /><br />Upgrading Solaris: 98% completed<br /><br /><br />Upgrading Solaris: 100% completed<br /><br />Installation of the packages from this media is complete.<br /><br />Deleted empty GRUB menu on ABE &lt;solexpr95&gt;.<br /><br />Adding operating system patches to the BE &lt;solexpr95&gt;.<br /><br />The operating system patch installation is complete.<br /><br />ABE boot partition backing deleted.<br /><br />Configuring failsafe for system.<br /><br />Failsafe configuration is complete.<br /><br />INFORMATION: The file &lt;/var/sadm/system/logs/upgrade_log&gt; on boot <br /><br />environment &lt;solexpr95&gt; contains a log of the upgrade operation.<br /><br />INFORMATION: The file &lt;/var/sadm/system/data/upgrade_cleanup&gt; on boot <br /><br />environment &lt;solexpr95&gt; contains a log of cleanup operations required.<br /><br />WARNING: &lt;6&gt; packages failed to install properly on boot environment &lt;solexpr95&gt;.<br /><br />INFORMATION: The file &lt;/var/sadm/system/data/upgrade_failed_pkgadds&gt; on <br /><br />boot environment &lt;solexpr95&gt; contains a list of packages that failed to <br /><br />upgrade or install properly.<br /><br />INFORMATION: Review the files listed above. Remember that all of the files <br /><br />are located on boot environment &lt;solexpr95&gt;. Before you activate boot <br /><br />environment &lt;solexpr95&gt;, determine if any additional system maintenance is <br /><br />required or if additional media of the software distribution must be <br /><br />installed.<br /><br />The Solaris upgrade of the boot environment &lt;solexpr95&gt; is partially complete.<br /><br />Installing failsafe<br /><br />Failsafe install is complete.<br /></pre>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 7. Once the <font color="#0000ff"><strong>luupgrade</strong></font> finishes ( Which takes about 30 to 45 minutes, at least for me it does. ) You should now run <font color="#0000ff"><strong>lustatus</strong></font>, which as the name<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; suggest it will give you the status of the BE's. </p>
<p>&nbsp;</p>
<pre>bash-3.2# <font color="#0000ff"><strong>lustatus </strong></font><br /><br /><br />Boot Environment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Is&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Active Active&nbsp;&nbsp;&nbsp; Can&nbsp;&nbsp;&nbsp; Copy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Complete Now&nbsp;&nbsp;&nbsp; On Reboot Delete Status&nbsp;&nbsp;&nbsp; <br /><br />-------------------------- -------- ------ --------- ------ ----------<br /><br />solexpr81&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>yes</strong>&nbsp;&nbsp;&nbsp; <strong>yes</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; no&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />solexpr95&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>no</strong>&nbsp;&nbsp;&nbsp;&nbsp; <strong>no</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yes&nbsp;&nbsp;&nbsp; -&nbsp; <br /><p>&nbsp;</p><p>&nbsp;</p></pre>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8. As you can see above solexpr81 which is the current BE is Active and is Active On Reboot as well. We need to change that so that<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; we can boot in to the new BE. We can do so by running <font color="#0000ff"><strong>luactivate</strong></font> and the BE name.</p>
<pre>&nbsp;</pre>
<p>&nbsp;</p>
<pre>bash-3.2# <strong><font color="#0000ff">luactivate</font> <font color="#ff0000">solexpr95</font></strong><br /><br />WARNING: &lt;6&gt; packages failed to install properly on boot environment &lt;solexpr95&gt;.<br /><br />INFORMATION: &lt;/var/sadm/system/data/upgrade_failed_pkgadds&gt; on boot<br /><br />environment &lt;solexpr95&gt; contains a list of packages that failed to upgrade<br /><br />or install properly. Review the file before you reboot the system to<br /><br />determine if any additional system maintenance is required.<br /><br /><br />Saving latest GRUB loader.<br /><br />Setting failsafe console to &lt;ttya&gt;.<br /><br />Generating partition and slice information for ABE &lt;solexpr95&gt;<br /><br />Boot menu exists.<br /><br />Generating direct boot menu entries for ABE.<br /><br />Generating direct boot menu entries for PBE.<br /><br /><br />**********************************************************************<br /><br /><br />The target boot environment has been activated. It will be used when you<br /><br />reboot. NOTE: You MUST NOT USE the reboot, halt, or uadmin commands. You<br /><br />MUST USE either the init or the shutdown command when you reboot. If you<br /><br />do not use either init or shutdown, the system will not boot using the<br /><br />target BE.<br /><br /><br />**********************************************************************<br /><br />In case of a failure while booting to the target BE, the following process<br /><br />needs to be followed to fallback to the currently working boot environment:<br /><br /><br />1. Do *not* change *hard* disk order in the BIOS.<br /><br /><br />2. Boot from the Solaris Install CD or Network and bring the system to<br /><br />Single User mode.<br /><br /><br />3. Mount the Parent boot environment root slice to some directory (like<br /><br />/mnt). You can use the following command to mount:<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp; mount -Fufs /dev/dsk/c0d0s0 /mnt<br /><br /><br />4. Run &lt;luactivate&gt; utility with out any arguments from the Parent boot<br /><br />environment root slice, as shown below:<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp; /mnt/sbin/luactivate<br /><br /><br />5. luactivate, activates the previous working boot environment and<br /><br />indicates the result.<br /><br /><br />6. Exit Single User mode and reboot the machine.<br /><br /><br />**********************************************************************<br /><br /><br />Modifying boot archive service<br /><br />GRUB menu is on device: &lt;/dev/dsk/c0d0s0&gt;.<br /><br />Filesystem type for menu device: &lt;ufs&gt;.<br /><br />Activation of boot environment &lt;solexpr95&gt; successful.</pre>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;&nbsp; &nbsp; 9. Now when that command successfully completes and give you a bunch of good info that you should take note of. HINT HINT.... <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If you run <font color="#0000ff"><strong>lustatus</strong></font> again the the ActiveOn Reboot should be no for solexpr81 and yes for solexpr95.</p>
<p>&nbsp;</p>
<pre>bash-3.2# <font color="#0000ff"><strong>lustatus </strong></font><br /><br /><br />Boot Environment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Is&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Active Active&nbsp;&nbsp;&nbsp; Can&nbsp;&nbsp;&nbsp; Copy&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br /><br />Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Complete Now&nbsp;&nbsp;&nbsp; On Reboot Delete Status&nbsp;&nbsp; &nbsp;<br /><br />-------------------------- -------- ------ --------- ------ ----------<br /><br />solexpr81&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>yes</strong>&nbsp;&nbsp;&nbsp; <strong>no</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; no&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br /><br />solexpr95&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>no</strong>&nbsp;&nbsp;&nbsp;&nbsp; <strong>yes</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; no&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp; </pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; 10. Now I'm sure by now you are wondering, what are the 6 errors that the LiveUpgrade process keeps telling us about. <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; In order to check the errors we will need to mount the /var partition.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<pre>bash-3.2# <strong><font color="#0000ff">mount -F</font> <font color="#ff0000">ufs</font> <font color="#ff0000">/dev/dsk/c0d0s6 /luvar</font> </strong></pre>
<p></p>
<p>&nbsp; &nbsp; &nbsp; 11. We can now view the file by running the following below... </p>
<p>&nbsp;</p>
<pre>bash-3.2# <font color="#0000ff"><strong>cat</strong></font> <font color="#ff0000"><strong>/luvar/sadm/system/data/upgrade_failed_pkgadds </strong></font><br /><br /><br />SUNWmccom<br /><br />SUNWfirefox<br /><br />SUNWthunderbird<br /><br />SUNWrealplayer<br /><br />SUNWfsexam-root<br /><br />SUNWfsexam</pre>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 12. Since the packages above are not really important we can now reboot the system, using the following below.</p>
<pre>&nbsp;</pre>
<pre>bash-3.2# <span style="font-weight: bold"><font color="#0000ff">sync</font>;<font color="#0000ff">sync</font>;<font color="#0000ff">shutdown -y -g0 -i6</font></span><br /></pre>
<p>
&nbsp;</p>
